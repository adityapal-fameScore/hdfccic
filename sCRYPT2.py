#!/usr/bin/env python3
"""
FAST Portfolio Analysis Dashboard — Instant startup.
Loads pre-computed JSON files (generated by precompute.py).

Usage:
  1. First run:  python precompute.py   (generates JSON files from Excel)
  2. Then run:   python sCRYPT2.py       (starts web server instantly)
"""

from flask import Flask, jsonify, request, send_from_directory
import json
import os
import sys
import time
from collections import defaultdict

app = Flask(__name__)

# ============================================================================
# PRE-COMPUTED DATA FILES
# ============================================================================

DATA_DIR = os.path.dirname(os.path.abspath(__file__))

DASHBOARD_FILE   = os.path.join(DATA_DIR, 'dashboard_records.json')
PORTFOLIO_FILE   = os.path.join(DATA_DIR, 'portfolio_metrics.json')
COMPARISON_FILE  = os.path.join(DATA_DIR, 'comparison_lookup.json')

# In-memory data (loaded once at startup)
dashboard_data = []
portfolio_data = {}
comparison_lookup = {}


# ============================================================================
# LOAD PRE-COMPUTED DATA (instant — just JSON reads)
# ============================================================================

def load_precomputed_data():
    """Load all pre-computed JSON files into memory."""
    global dashboard_data, portfolio_data, comparison_lookup

    required_files = [
        (DASHBOARD_FILE, 'dashboard_records.json'),
        (PORTFOLIO_FILE, 'portfolio_metrics.json'),
        (COMPARISON_FILE, 'comparison_lookup.json'),
    ]

    for filepath, name in required_files:
        if not os.path.exists(filepath):
            print(f"\n  ✗ ERROR: Missing file: {name}")
            print(f"    Run 'python precompute.py' first to generate the data files.\n")
            sys.exit(1)

    start = time.time()

    with open(DASHBOARD_FILE, 'r', encoding='utf-8') as f:
        dashboard_data = json.load(f)
    print(f"  ✓ dashboard_records.json  — {len(dashboard_data):,} records")

    with open(PORTFOLIO_FILE, 'r', encoding='utf-8') as f:
        portfolio_data = json.load(f)
    print(f"  ✓ portfolio_metrics.json  — loaded")

    with open(COMPARISON_FILE, 'r', encoding='utf-8') as f:
        comparison_lookup = json.load(f)
    print(f"  ✓ comparison_lookup.json  — {len(comparison_lookup):,} LOS IDs")

    elapsed = time.time() - start
    print(f"\n  ⚡ All data loaded in {elapsed:.2f}s")


# ============================================================================
# HELPER
# ============================================================================

def format_value(value):
    """Format a value for display."""
    if value is None:
        return '—'
    if isinstance(value, int):
        return f'{value:,}'
    if isinstance(value, float):
        return f'{value:,.2f}'
    return str(value)


# ============================================================================
# API ROUTES
# ============================================================================

@app.route('/api/dashboard')
def api_dashboard():
    """Dashboard API — returns ALL records (client-side pagination)."""
    search = request.args.get('search', '').lower()

    filtered = dashboard_data
    if search:
        filtered = [r for r in dashboard_data if search in str(r['pan']).lower()
                    or search in str(r['old_los_id']) or search in str(r['new_los_id'])]

    return jsonify({
        'data': filtered,
        'total': len(dashboard_data)
    })


@app.route('/api/portfolio-analysis')
def api_portfolio_analysis():
    old_status_val = request.args.get('old_status', '').strip().lower()
    status_filter = request.args.get('status', '').strip().lower()
    program_filter = request.args.get('program', '').strip().lower()

    # Always filter and calculate live for consistency
    filtered_records = []
    for r in dashboard_data:
        old_status_match = not old_status_val or str(r.get('old_status', '')).lower() == old_status_val
        status_match = not status_filter or str(r.get('new_status', '')).lower() == status_filter
        program_match = not program_filter or str(r.get('new_program', '')).lower() == program_filter
        if old_status_match and status_match and program_match:
            filtered_records.append(r)

    # Return live calculation
    return jsonify(_calculate_live_metrics(filtered_records))


@app.route('/api/drill-down')
def api_drill_down():
    metric = request.args.get('metric')
    old_status_val = request.args.get('old_status', '').strip().lower()
    status_filter = request.args.get('status', '').strip().lower()
    program_filter = request.args.get('program', '').strip().lower()
    industry_filter = request.args.get('industry', '').strip()
    state_filter = request.args.get('state', '').strip()

    if not metric or not portfolio_data:
        return jsonify({'error': 'Invalid'}), 400

    # Always calculate live for consistency with dashboard cards
    # If no filters, we still use dashboard_data to ensure sync
    target_records = dashboard_data
    
    # Apply filters if present
    if old_status_val or status_filter or program_filter or industry_filter or state_filter:
        filtered_input = []
        for r in dashboard_data:
            if old_status_val and str(r.get('old_status', '')).lower() != old_status_val: continue
            if status_filter and str(r.get('new_status', '')).lower() != status_filter: continue
            if program_filter and str(r.get('new_program', '')).lower() != program_filter: continue
            if industry_filter and r.get('industry') != industry_filter: continue
            if state_filter and r.get('state') != state_filter: continue
            filtered_input.append(r)
        target_records = filtered_input

    # Re-calculate metrics for the subset
    live_results = _calculate_live_metrics(target_records)
    raw_res = live_results.get(metric)
    cases_to_return = raw_res if isinstance(raw_res, list) else []
    
    return jsonify({'metric': str(metric), 'count': len(cases_to_return), 'cases': cases_to_return})


@app.route('/api/multi-param-filter')
def api_multi_param_filter():
    """Multi-parameter AND filter — returns cases matching ALL selected parameters."""
    params_str = request.args.get('params', '').strip()
    old_status_val = request.args.get('old_status', '').strip().lower()
    status_filter = request.args.get('status', '').strip().lower()
    program_filter = request.args.get('program', '').strip().lower()

    if not params_str:
        return jsonify({'error': 'No parameters selected'}), 400

    selected_params = [p.strip() for p in params_str.split(',') if p.strip()]

    # Filter records by status/program first
    filtered_records = []
    for r in dashboard_data:
        if old_status_val and str(r.get('old_status', '')).lower() != old_status_val: continue
        if status_filter and str(r.get('new_status', '')).lower() != status_filter: continue
        if program_filter and str(r.get('new_program', '')).lower() != program_filter: continue
        filtered_records.append(r)

    # Create a lookup for original records by ID to reconstruct the list later
    # (Because _calculate_live_metrics needs raw records, but returns processed 'case' objects)
    raw_record_map = {
        (str(r.get('old_los_id')), str(r.get('new_los_id'))): r 
        for r in filtered_records
    }

    # Calculate metrics for filtered records
    metrics = _calculate_live_metrics(filtered_records)

    # Build case maps for each selected parameter
    param_case_maps = {}
    for param in selected_params:
        case_list = metrics.get(param, [])
        case_map = {}
        for c in case_list:
            if not isinstance(c, dict): continue
            # Use tuple key compatible with raw_record_map
            old_val = str(c.get('old_los', ''))
            new_val = str(c.get('new_los', ''))
            key = (old_val, new_val)
            case_map[key] = c
        param_case_maps[param] = case_map

    # Intersection of keys (AND operation)
    intersection_keys = set()
    if param_case_maps:
        keys_list = [set(m.keys()) for m in param_case_maps.values()]
        if len(keys_list) > 0:
            intersection_keys = keys_list[0].copy()
            for i in range(1, len(keys_list)):
                intersection_keys = intersection_keys & keys_list[i]

    # Retrieve ORIGINAL records for the intersection
    # intersection_keys contains (old_los, new_los) tuples
    result_raw_records = []
    for key in intersection_keys:
        if key in raw_record_map:
            result_raw_records.append(raw_record_map[key])

    # Re-calculate FULL metrics for the AND-filtered subset using RAW records
    filtered_metrics = _calculate_live_metrics(result_raw_records)
    
    def to_display_case(r):
        return {
            'pan': r.get('pan_no'), 'old_los': r.get('old_los_id'), 'new_los': r.get('new_los_id'),
            'industry': r.get('industry'), 'state': r.get('state'), 'info': 'Matched', # Info placeholder
            'old_status': r.get('old_status'), 'new_status': r.get('new_status')
        }
    
    display_cases = [to_display_case(r) for r in result_raw_records]

    return jsonify({
        'count': len(result_raw_records),
        'cases': display_cases,
        'selected_params': selected_params,
        # Merge full metrics for dashboard update
        'counts': filtered_metrics['counts'],
        'total_pans': filtered_metrics['total_pans'],
        'industry_breakdown': filtered_metrics['industry_breakdown'],
        'state_breakdown': filtered_metrics['state_breakdown']
    })


@app.route('/api/compare')
def api_compare():
    """Comparison API — /api/compare?old=X&new=Y"""
    old_los = request.args.get('old')
    new_los = request.args.get('new')
    if not old_los or not new_los:
        return jsonify({'error': 'Missing parameters'}), 400
    return _get_comparison(str(old_los), str(new_los))


def safe_float(v, is_score=False):
    """
    Safely convert value to float.
    is_score=True: treats 0-equivalents as None (for CIBIL/CMR).
    is_score=False: treats 0 as 0.0 (for DPD, WD, etc).
    """
    if v is None or v == '':
        return None
    try:
        f = float(v)
        if is_score and f <= 0:
            return None
        return f
    except (ValueError, TypeError):
        return None


def _calculate_live_metrics(records):
    """Calculate the 17 metrics live for a subset of records."""
    if not isinstance(records, (list, tuple)):
        return None

    # Using separate lists to satisfy strict type checkers
    m_cibil_drop = []
    m_cmr_inc = []
    m_cmr_gt7 = []
    m_cibil_lt700 = []
    m_wd_p = []
    m_wd_c = []
    m_dpd15_c = []
    m_dpd15_imp = []
    m_dpd15_deg = []
    m_dpd30_c = []
    m_dpd30_imp = []
    m_dpd30_deg = []
    m_sales_drp = []
    m_usl_inc = []
    m_pur_gt_sale = []
    m_turn_not_inc = []
    m_turn_dec = []
    m_bto_drp = []
    m_bto_gt150 = []
    m_dev_1 = []
    m_dev_2 = []
    m_dev_3p = []

    def make_dr_record(rec, val_info=None):
        return {
            'pan': str(rec.get('pan', '—')), 
            'old_los': str(rec.get('old_los_id', '—')), 
            'new_los': str(rec.get('new_los_id', '—')),
            'industry': str(rec.get('industry', '—')), 
            'state': str(rec.get('state', '—')), 
            'info': str(val_info) if val_info else '—',
            'old_status': str(rec.get('old_status', '—')), 
            'new_status': str(rec.get('new_status', '—'))
        }

    industry_metrics = {}
    state_metrics = {}

    for r in records:
        oid = str(r.get('old_los_id', ''))
        nid = str(r.get('new_los_id', ''))
        old_rec = comparison_lookup.get(oid)
        new_rec = comparison_lookup.get(nid)
        
        if not isinstance(old_rec, dict) or not isinstance(new_rec, dict):
            continue

        ind = str(r.get('industry', 'Unknown'))
        st = str(r.get('state', 'Unknown'))

        oc = safe_float(old_rec.get('ConsumerBureaucreditScore'), is_score=True)
        nc = safe_float(new_rec.get('ConsumerBureaucreditScore'), is_score=True)
        ocm = safe_float(old_rec.get('CommercialBureaucmrScore'), is_score=True)
        ncm = safe_float(new_rec.get('CommercialBureaucmrScore'), is_score=True)

        # 1. CIBIL Drop
        if oc is not None and nc is not None and (oc - nc) >= 50:
            m_cibil_drop.append(make_dr_record(r, f"{oc:.0f}->{nc:.0f}"))
            if ind not in industry_metrics: industry_metrics[ind] = {}
            industry_metrics[ind]['cibil_drop_50plus'] = industry_metrics[ind].get('cibil_drop_50plus', 0) + 1
            if st not in state_metrics: state_metrics[st] = {}
            state_metrics[st]['cibil_drop_50plus'] = state_metrics[st].get('cibil_drop_50plus', 0) + 1

        # 2. CMR Increase
        if ocm is not None and ncm is not None and (ncm - ocm) >= 2 and ncm != 10:
            m_cmr_inc.append(make_dr_record(r, f"{ocm:.0f}->{ncm:.0f}"))

        # 3. CMR > 7
        if ncm is not None and ncm > 7:
            m_cmr_gt7.append(make_dr_record(r, f"CMR: {ncm:.0f}"))

        # 4. CIBIL < 700
        if nc is not None and nc < 700:
            m_cibil_lt700.append(make_dr_record(r, f"CIBIL: {nc:.0f}"))

        # 5. Willful Default
        wd_new = (safe_float(new_rec.get('ConsumerBureaunoOfWillFulDefaults')) or 0) + \
                 (safe_float(new_rec.get('CommercialBureaunoOfWillFulDefaults')) or 0)
        if wd_new > 0:
            m_wd_c.append(make_dr_record(r, f"WD: {wd_new:.0f}"))
            if ind not in industry_metrics: industry_metrics[ind] = {}
            industry_metrics[ind]['willful_default_child'] = industry_metrics[ind].get('willful_default_child', 0) + 1
            if st not in state_metrics: state_metrics[st] = {}
            state_metrics[st]['willful_default_child'] = state_metrics[st].get('willful_default_child', 0) + 1

        # 7. DPD 15+
        dpd15_new = (safe_float(new_rec.get('ConsumerBureaufifteenPlusDPD')) or 0) + \
                   (safe_float(new_rec.get('CommercialBureaufifteenPlusDPD')) or 0)
        if dpd15_new > 0:
            m_dpd15_c.append(make_dr_record(r, f"DPD: {dpd15_new:.0f}"))

        # 10. DPD 30+
        dpd30_new = (safe_float(new_rec.get('ConsumerBureauthirtyPlusDPD')) or 0) + \
                   (safe_float(new_rec.get('CommercialBureauthirtyPlusDPD')) or 0)
        if dpd30_new > 0:
            m_dpd30_c.append(make_dr_record(r, f"DPD: {dpd30_new:.0f}"))
            if ind not in industry_metrics: industry_metrics[ind] = {}
            industry_metrics[ind]['dpd_30plus_child'] = industry_metrics[ind].get('dpd_30plus_child', 0) + 1
            if st not in state_metrics: state_metrics[st] = {}
            state_metrics[st]['dpd_30plus_child'] = state_metrics[st].get('dpd_30plus_child', 0) + 1

        # 13. Sales Dropped
        ot = safe_float(old_rec.get('GstnDatalastTwelveMonthTurnOver'))
        nt = safe_float(new_rec.get('GstnDatalastTwelveMonthTurnOver'))
        if ot is not None and nt is not None and ot > 0 and nt < (ot * 0.9):
            m_sales_drp.append(make_dr_record(r, f"{ot:,.0f}->{nt:,.0f}"))
            if ind not in industry_metrics: industry_metrics[ind] = {}
            industry_metrics[ind]['sales_dropped'] = industry_metrics[ind].get('sales_dropped', 0) + 1
            if st not in state_metrics: state_metrics[st] = {}
            state_metrics[st]['sales_dropped'] = state_metrics[st].get('sales_dropped', 0) + 1

        # 14. USL Increase
        ousl = (safe_float(old_rec.get('ConsumerBureautotalUSLOutStanding')) or 0) + \
               (safe_float(old_rec.get('CommercialBureautotalUSLOutStanding')) or 0)
        nusl = (safe_float(new_rec.get('ConsumerBureautotalUSLOutStanding')) or 0) + \
               (safe_float(new_rec.get('CommercialBureautotalUSLOutStanding')) or 0)
        if ousl > 0 and (nusl - ousl) / ousl >= 0.3:
            m_usl_inc.append(make_dr_record(r, f"{ousl:,.0f}->{nusl:,.0f}"))

        # 15. Purchase > Sales
        np = safe_float(new_rec.get('GstnDatalastTwelveMonthPurchase'))
        if nt is not None and np is not None and nt > 0 and np > (nt * 1.3):
            m_pur_gt_sale.append(make_dr_record(r, f"S:{nt:,.0f} P:{np:,.0f}"))

        # 16. Turnover
        omcp = safe_float(old_rec.get('mcpLastTwelveMonthTurnOver'))
        nmcp = safe_float(new_rec.get('mcpLastTwelveMonthTurnOver'))
        if omcp is not None and nmcp is not None:
            if nmcp <= omcp:
                m_turn_not_inc.append(make_dr_record(r, f"{omcp:,.0f}->{nmcp:,.0f}"))
            if nmcp < omcp:
                m_turn_dec.append(make_dr_record(r, f"{omcp:,.0f}->{nmcp:,.0f}"))

        # 18. BTO
        obto = safe_float(old_rec.get('BankDataSummarybtoOfAvgTurnOverLastTwelveMonths'))
        nbto = safe_float(new_rec.get('BankDataSummarybtoOfAvgTurnOverLastTwelveMonths'))
        if obto is not None and nbto is not None and (obto - nbto) >= 25:
            m_bto_drp.append(make_dr_record(r, f"{obto}%->{nbto}%"))
        if nbto is not None and nbto > 150:
            m_bto_gt150.append(make_dr_record(r, f"BTO: {nbto}%"))

        # Deviations
        dev_c = _count_deviations_live(new_rec)
        if dev_c == 1:
            m_dev_1.append(make_dr_record(r, "1 Deviation"))
        elif dev_c == 2:
            m_dev_2.append(make_dr_record(r, "2 Deviations"))
        elif dev_c >= 3:
            m_dev_3p.append(make_dr_record(r, f"{dev_c} Deviations"))

    metrics = {
        'total_pans': len(records),
        'counts': {
            'cibil_drop_50plus': len(m_cibil_drop),
            'cmr_increase_2plus': len(m_cmr_inc),
            'cmr_rank_gt7_child': len(m_cmr_gt7),
            'cibil_lt700_child': len(m_cibil_lt700),
            'willful_default_parent': len(m_wd_p),
            'willful_default_child': len(m_wd_c),
            'dpd_15plus_child': len(m_dpd15_c),
            'dpd_15plus_improved': len(m_dpd15_imp),
            'dpd_15plus_degraded': len(m_dpd15_deg),
            'dpd_30plus_child': len(m_dpd30_c),
            'dpd_30plus_improved': len(m_dpd30_imp),
            'dpd_30plus_degraded': len(m_dpd30_deg),
            'sales_dropped': len(m_sales_drp),
            'usl_increase_30pct': len(m_usl_inc),
            'purchase_gt_sales_30pct': len(m_pur_gt_sale),
            'turnover_not_increased': len(m_turn_not_inc),
            'turnover_decreased': len(m_turn_dec),
            'bto_drop_25pct': len(m_bto_drp),
            'bto_gt_150pct': len(m_bto_gt150),
            'deviation_count_1': len(m_dev_1),
            'deviation_count_2': len(m_dev_2),
            'deviation_count_3plus': len(m_dev_3p)
        },
        'cibil_drop_50plus': m_cibil_drop,
        'cmr_increase_2plus': m_cmr_inc,
        'cmr_rank_gt7_child': m_cmr_gt7,
        'cibil_lt700_child': m_cibil_lt700,
        'willful_default_parent': m_wd_p,
        'willful_default_child': m_wd_c,
        'dpd_15plus_child': m_dpd15_c,
        'dpd_15plus_improved': m_dpd15_imp,
        'dpd_15plus_degraded': m_dpd15_deg,
        'dpd_30plus_child': m_dpd30_c,
        'dpd_30plus_improved': m_dpd30_imp,
        'dpd_30plus_degraded': m_dpd30_deg,
        'sales_dropped': m_sales_drp,
        'usl_increase_30pct': m_usl_inc,
        'purchase_gt_sales_30pct': m_pur_gt_sale,
        'turnover_not_increased': m_turn_not_inc,
        'turnover_decreased': m_turn_dec,
        'bto_drop_25pct': m_bto_drp,
        'bto_gt_150pct': m_bto_gt150,
        'deviation_count_1': m_dev_1,
        'deviation_count_2': m_dev_2,
        'deviation_count_3plus': m_dev_3p
    }

    # Flatten and sort breakdowns
    metrics['industry_breakdown'] = sorted(
        [{'name': str(k), **v} for k, v in industry_metrics.items()],
        key=lambda x: int(x.get('cibil_drop_50plus', 0)), reverse=True
    )
    metrics['state_breakdown'] = sorted(
        [{'name': str(k), **v} for k, v in state_metrics.items()],
        key=lambda x: int(x.get('cibil_drop_50plus', 0)), reverse=True
    )

    return metrics




# Complete deviation-to-criticality mapping (for display in comparison view)
DEVIATION_CRITICALITY = {
    # BankDataSummary
    'noOfMonthsBankStatementRequired': 'NA',
    'btoOfAvgTurnOverLastTwelveMonths': 'HIGH',
    'chequeReturnInwardCount': 'HIGH',
    'btoOfAvgPurchaseLastTwelveMonths': 'MEDIUM',
    # BusinessProfile
    'businessVintage': 'MEDIUM',
    'tradeNameKeyWordMatches': 'MEDIUM',
    'lchu': 'NA',
    'obca': 'NA',
    'delinquency': 'NA',
    # Commercial Bureau
    'totalWorkingCapitalSetup': 'NA',
    'noOfWriteOffSuitFiledDoubtSubStd': 'HIGH',
    'noOfNPA': 'HIGH',
    'cmrScore': 'HIGH',
    'thirtyPlusDPD': 'HIGH',
    'noOfWillFulDefaults': 'HIGH',
    'fifteenPlusDPD': 'MEDIUM',
    'maxDPDCommercial': 'MEDIUM',
    'commercialBureauFlag': 'NA',
    # Consumer Bureau
    'creditScore': 'HIGH',
    'maxDPDConsumer': 'MEDIUM',
    'consumerBureauFlag': 'NA',
    # GstnData
    'consitentDipInSameMonthsInLastTwoYears': 'MEDIUM',
    'lowestMonthlySalesOverLastTwelveMonthsAveSales': 'MEDIUM',
    'grossProfitPercentageInLastTwelveMonths': 'HIGH',
    'countOfQuarterlySalesLessThanNintyFivePercentAndGreaterThanSixtyPercent': 'MEDIUM',
    'totalSalesInLastTwelveMonthsOverPreviousTwelveMonths': 'MEDIUM',
    'countOfQuarterlySalesLessThanSixtyPercent': 'MEDIUM',
    'totalGst3BFilingDelayInLastTwelveMonths': 'MEDIUM',
    'lastTwelveMonthTurnOver': 'NA',
    # Posidex
    'posidexEnquiryPresent': 'MEDIUM',
    'posidexRemarksCheck': 'MEDIUM',
    'creditBalanceRatioCheck': 'NA',
    'posidexStatus': 'HIGH',
}

# All known deviation names sorted by length (longest first to avoid partial matches)
_ALL_DEVIATION_NAMES = sorted(DEVIATION_CRITICALITY.keys(), key=len, reverse=True)



# Prefix to Category mapping (found in raw data segments)
PREFIX_CATEGORY_MAP = {
    'BankDataSummary-': 'Bank Banking',
    'BusinessProfile-': 'Business Profile',
    'CommercialBureau-': 'Commercial Bureau',
    'ConsumerBureau-': 'Consumer Bureau',
    'GstnData-': 'GSTN',
    'Posidex-': 'Posidex',
}

def _parse_deviation(segment, default_category):
    """
    Parse a raw deviation segment.
    1. Check for category prefix (e.g. 'BankDataSummary-...') and override default_category.
    2. Extract clean deviation name (strip prefix and trailing metadata).
    Returns (name, category).
    """
    segment = segment.strip()
    category = default_category

    # 1. Handle Prefix
    for prefix, mapped_cat in PREFIX_CATEGORY_MAP.items():
        if segment.startswith(prefix):
            category = mapped_cat
            segment = segment[len(prefix):]  # Strip prefix
            break

    # 2. Extract Name (strip metadata like -100-->... or -- 2)
    # Match against known names first
    clean_name = segment
    found = False
    for name in _ALL_DEVIATION_NAMES:
        if segment.startswith(name):
            clean_name = name
            found = True
            break
    
    if not found:
        # Fallback regex for unknown names
        import re
        match = re.match(r'^([a-zA-Z_]+)', segment)
        if match:
            clean_name = match.group(1)

    return clean_name, category


def _count_deviations_live(record):
    """Count only UNIQUE HIGH criticality deviations."""
    if not isinstance(record, dict):
        return 0

    deviation_cols = ['BankDataSummaryDeviation', 'GstnDataDeviation', 'BusinessProfileDeviation',
                      'PosidexDeviation', 'ConsumerBureauDeviation', 'CommercialBureauDeviation']
    
    col_defaults = {
        'BankDataSummaryDeviation': 'Bank Banking',
        'GstnDataDeviation': 'GSTN',
        'BusinessProfileDeviation': 'Business Profile',
        'PosidexDeviation': 'Posidex',
        'ConsumerBureauDeviation': 'Consumer Bureau',
        'CommercialBureauDeviation': 'Commercial Bureau'
    }

    unique_high_deviations = set()
    for col in deviation_cols:
        val = record.get(col)
        if val is not None and val not in [0, '0', 'No', 'NO', 'no', False, 'False']:
            segments = [s.strip() for s in str(val).split(' || ') if s.strip()]
            for seg in segments:
                name, _ = _parse_deviation(seg, col_defaults.get(col, 'Other'))
                if DEVIATION_CRITICALITY.get(name) == 'HIGH':
                    unique_high_deviations.add(name)
    return len(unique_high_deviations)


def _get_comparison(old_los_str, new_los_str):
    """Perform comparison using pre-computed lookup (no pandas needed)."""
    try:
        if comparison_lookup is None:
             return jsonify({'error': 'Data not yet loaded'}), 503

        old_rec = comparison_lookup.get(old_los_str)
        new_rec = comparison_lookup.get(new_los_str)

        if not old_rec or not new_rec:
            return jsonify({'error': f'LOS ID not found: {old_los_str if not old_rec else new_los_str}'}), 404

        params = [
            # CRITICAL PARAMETERS - Listed First
            ('Commercial CMR Score', 'CommercialBureaucmrScore', False, True),
            ('Consumer Credit Score', 'ConsumerBureaucreditScore', True, True),
            ('Consumer Wilful Defaults', 'ConsumerBureaunoOfWillFulDefaults', False, True),
            ('Commercial Wilful Defaults', 'CommercialBureaunoOfWillFulDefaults', False, True),
            ('Consumer Write-offs', 'ConsumerBureaunoOfWriteOffSuitFiledDoubtSubStd', False, True),
            ('Commercial Write-offs', 'CommercialBureaunoOfWriteOffSuitFiledDoubtSubStd', False, True),
            ('Consumer NPA', 'ConsumerBureaunoOfNPA', False, True),
            ('Commercial NPA', 'CommercialBureaunoOfNPA', False, True),
            ('Credit Limit', 'credit_limit_amt', True, True),
            ('Consumer Working Capital', 'ConsumerBureautotalWorkingCapitalSetup', True, True),
            ('Commercial Working Capital', 'CommercialBureautotalWorkingCapitalSetup', True, True),
            ('Cheque Return Count', 'BankDataSummarychequeReturnInwardCount', False, True),

            # STANDARD PARAMETERS
            ('Consumer 15+ DPD', 'ConsumerBureaufifteenPlusDPD', False, False),
            ('Commercial 15+ DPD', 'CommercialBureaufifteenPlusDPD', False, False),
            ('Consumer 30+ DPD', 'ConsumerBureauthirtyPlusDPD', False, False),
            ('Commercial 30+ DPD', 'CommercialBureauthirtyPlusDPD', False, False),
            ('Bank BTO Avg Purchase', 'BankDataSummarybtoOfAvgPurchaseLastTwelveMonths', True, False),
            ('Bank BTO Avg Turnover', 'BankDataSummarybtoOfAvgTurnOverLastTwelveMonths', True, False),
            ('GSTN Purchase (12M)', 'GstnDatalastTwelveMonthPurchase', True, False),
            ('GSTN Turnover (12M)', 'GstnDatalastTwelveMonthTurnOver', True, False),
            ('GSTN Gross Profit %', 'GstnDatagrossProfitPercentageInLastTwelveMonths', True, False),
            ('GST Delay Count (≥20d)', 'GstnDatagstDelayCountGreaterThanOrEqualsTwentyDaysInLastTwelveMonths', False, False),
            ('GST 3B Filing Delay', 'GstnDatatotalGst3BFilingDelayInLastTwelveMonths', False, False),
            ('Bank Avg Monthly Credit', 'BankDataSummaryaveMonthlyCredit', True, False),
            ('Bank Avg Monthly Debit', 'BankDataSummaryaveMonthlyDebit', False, False),
            ('GSTN Avg Purchase (GST2A)', 'GstnDataavePurchaseInLastTwelveMonthsGST2A', True, False),
            ('GSTN Avg Sales (GSTR1)', 'GstnDataaveSalesInLastTwelveMonthsGSTR1', True, False),
            ('Consumer USL Outstanding', 'ConsumerBureautotalUSLOutStanding', False, False),
            ('Commercial USL Outstanding', 'CommercialBureautotalUSLOutStanding', False, False),
            ('MCP BTO Avg Turnover', 'mcpBtoOfAvgTurnOverLastTwelveMonths', True, False),
            ('MCP Credit Score', 'mcpCreditScore', True, False),
            ('MCP Turnover (12M)', 'mcpLastTwelveMonthTurnOver', True, False),
        ]

        comparisons = []
        has_critical = False

        for name, col, higher_better, is_critical in params:
            ov = old_rec.get(col)
            nv = new_rec.get(col)
            change = '—'
            status = 'no_data'
            is_highly_critical = False

            # Treat 0 as None (No Data)
            ov_val = ov if ov not in [None, 0, 0.0, '0', '0.0'] else None
            nv_val = nv if nv not in [None, 0, 0.0, '0', '0.0'] else None

            if ov_val is not None and nv_val is not None:
                try:
                    diff = float(nv_val) - float(ov_val)
                    change = f"{diff:+,.2f}"
                    if abs(diff) < 0.01:
                        status = 'unchanged'
                    elif (diff > 0 and higher_better) or (diff < 0 and not higher_better):
                        status = 'improved'
                    else:
                        status = 'degraded'
                    # Critical check
                    if is_critical and status == 'degraded':
                        if 'Credit Score' in name and abs(diff) >= 50:
                            is_highly_critical = True
                            has_critical = True
                        elif 'CMR' in name and diff >= 2:
                            is_highly_critical = True
                            has_critical = True
                except (ValueError, TypeError):
                    pass

            comparisons.append({
                'parameter': name,
                'old_value': format_value(ov_val),
                'new_value': format_value(nv_val),
                'change': change,
                'status': status,
                'is_critical': is_critical,
                'is_highly_critical': is_highly_critical
            })

        # Deviation Logic — Categorized, HIGH criticality only
        deviation_col_category = {
            'ConsumerBureauDeviation': 'Consumer Bureau',
            'CommercialBureauDeviation': 'Commercial Bureau',
            'BankDataSummaryDeviation': 'Bank Banking',
            'GstnDataDeviation': 'GSTN',
            'BusinessProfileDeviation': 'Business Profile',
            'PosidexDeviation': 'Posidex',
        }

        active_deviations = set()
        categorized_deviations = {}

        for col, default_cat in deviation_col_category.items():
            val = new_rec.get(col)
            if val and val not in [0, '0', 'No', 'NO', 'no', False, None, 'False']:
                segments = [s.strip() for s in str(val).split(' || ') if s.strip()]
                
                for seg in segments:
                    # Parse name and category (handling prefixes)
                    dev_name, final_cat = _parse_deviation(seg, default_cat)
                    
                    # Store distinct active deviation names
                    if dev_name not in active_deviations: 
                         active_deviations.add(dev_name)

                         # Categorize HIGH criticality ones
                         if DEVIATION_CRITICALITY.get(dev_name) == 'HIGH':
                             if final_cat in ['Consumer Bureau', 'Commercial Bureau']:
                                 clist = categorized_deviations.get('Critical', [])
                                 if isinstance(clist, list): 
                                     clist.append(dev_name)
                                     categorized_deviations['Critical'] = clist
                                 
                                 flist = categorized_deviations.get(final_cat, [])
                                 if isinstance(flist, list):
                                     flist.append(dev_name)
                                     categorized_deviations[final_cat] = flist
                             elif final_cat == 'Bank Banking':
                                 blist = categorized_deviations.get('Bank Banking', [])
                                 if isinstance(blist, list):
                                     blist.append(dev_name)
                                     categorized_deviations['Bank Banking'] = blist
                             else:
                                 olist = categorized_deviations.get('Other', [])
                                 if isinstance(olist, list):
                                     olist.append(dev_name)
                                     categorized_deviations['Other'] = olist

        # Collect ALL deviations with criticality for the full table display
        all_deviations_table = []
        seen_deviations = set()
        for col, default_cat in deviation_col_category.items():
            val = new_rec.get(col)
            if val and val not in [0, '0', 'No', 'NO', 'no', False, None, 'False']:
                segments = [s.strip() for s in str(val).split(' || ') if s.strip()]
                for seg in segments:
                    dev_name, final_cat = _parse_deviation(seg, default_cat)
                    if dev_name in seen_deviations:
                        continue
                    seen_deviations.add(dev_name)

                    crit = DEVIATION_CRITICALITY.get(dev_name, 'MEDIUM')
                    all_deviations_table.append({
                        'name': dev_name,
                        'category': final_cat,
                        'criticality': crit
                    })

        # Calculate critical deviation count
        critical_dev_count = sum(len(items) for items in categorized_deviations.values())

        return jsonify({
            'pan': old_rec.get('pan_no', '—'),
            'old_los_id': old_los_str,
            'new_los_id': new_los_str,
            'old_program': old_rec.get('program_name', '—'),
            'new_program': new_rec.get('program_name', '—'),
            'old_status': old_rec.get('approval_status', '—'),
            'new_status': new_rec.get('approval_status', '—'),
            'old_created': old_rec.get('created_on', '—'),
            'new_created': new_rec.get('created_on', '—'),
            'rm_name': new_rec.get('SalesRMName', '—'),
            'deviations': list(active_deviations),
            'categorized_deviations': categorized_deviations,
            'all_deviations_table': all_deviations_table,
            'has_critical_case': has_critical,
            'critical_dev_count': critical_dev_count,
            'comparisons': comparisons
        })
    except Exception as e:
        return jsonify({'error': str(e)}), 500




# ============================================================================
# HTML TEMPLATE (Exact script1.py UI with 17 Metrics + Drill-Down)
# ============================================================================

HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOS Comparison Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', 'Helvetica Neue', Arial, sans-serif; background: #f4f4f4; color: #161616; line-height: 1.6; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        .slide-down { animation: slideDown 0.4s ease-out; }

        .header { background: #ffffff; border-bottom: 1px solid #e0e0e0; padding: 1rem 2rem; animation: slideDown 0.5s ease-out; display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .header-logo { height: 20px; width: auto; }
        .header h1 { font-size: 1.5rem; font-weight: 400; color: #161616; margin: 0; }
        .cache-info { font-size: 0.75rem; color: #525252; display: flex; gap: 0.5rem; align-items: center; }
        .cache-badge { padding: 0.25rem 0.5rem; background: #d2f4ea; color: #0e6027; border-radius: 2px; font-weight: 600; }

        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }

        .search-section { background: #ffffff; padding: 1.5rem; margin-bottom: 1rem; border: 1px solid #e0e0e0; animation: slideDown 0.6s ease-out; }
        .search-bar { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .filter-bar { display: flex; gap: 0.5rem; align-items: center; }
        .filter-label { font-size: 0.875rem; color: #525252; font-weight: 500; }
        .search-input, .filter-select { flex: 1; padding: 0.625rem 1rem; border: 1px solid #dde1e6; font-size: 0.875rem; outline: none; font-family: inherit; transition: all 0.2s cubic-bezier(0.2, 0, 0.38, 0.9); background: #ffffff; border-radius: 4px; height: 44px; appearance: none; }
        .filter-select { flex: 0 0 220px; cursor: pointer; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23525252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 1rem center; padding-right: 2.5rem; }
        .search-input:focus, .filter-select:focus { border-color: #0f62fe; box-shadow: 0 0 0 3px rgba(15, 98, 254, 0.1); }

        .btn { padding: 0 1.5rem; background: #0f62fe; color: #ffffff; border: none; font-size: 0.875rem; cursor: pointer; font-family: inherit; font-weight: 500; transition: all 0.2s cubic-bezier(0.2, 0, 0.38, 0.9); border-radius: 4px; height: 44px; display: inline-flex; align-items: center; justify-content: center; }
        .btn:hover { background: #0353e9; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(15, 98, 254, 0.2); }
        .btn-secondary { background: #393939; }
        .btn-secondary:hover { background: #4c4c4c; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }

        .stats { background: #ffffff; padding: 1rem 1.5rem; margin-bottom: 1rem; border: 1px solid #e0e0e0; display: flex; gap: 2rem; font-size: 0.875rem; animation: slideDown 0.7s ease-out; }
        .stat-item { color: #525252; }
        .stat-value { font-weight: 600; color: #161616; margin-left: 0.5rem; }

        .view-toggle { background: #ffffff; padding: 1rem 1.5rem; margin-bottom: 1rem; border: 1px solid #e0e0e0; animation: slideDown 0.8s ease-out; }
        .tab-buttons { display: flex; gap: 0.5rem; }
        .tab-btn { padding: 0.5rem 1rem; background: transparent; border: 1px solid #8d8d8d; color: #161616; cursor: pointer; font-size: 0.875rem; font-family: inherit; transition: all 0.2s ease; }
        .tab-btn:hover { background: #f4f4f4; }
        .tab-btn.active { background: #e0e0e0; border-color: #e0e0e0; }

        .view { display: none; }
        .view.active { display: block; }

        table { width: 100%; background: #ffffff; border: 1px solid #e0e0e0; border-collapse: collapse; font-size: 0.875rem; }
        thead { background: #e0e0e0; }
        th { text-align: left; padding: 0.75rem 1rem; font-weight: 600; color: #161616; border-bottom: 1px solid #8d8d8d; }
        td { padding: 0.75rem 1rem; border-bottom: 1px solid #e0e0e0; transition: background 0.2s ease; }
        tbody tr { transition: all 0.2s ease; }
        tbody tr:hover { background: #f4f4f4; }

        .status { display: inline-block; padding: 0.125rem 0.5rem; font-size: 0.75rem; border-radius: 0; }
        .status-approved { background: #d2f4ea; color: #0e6027; }
        .status-rejected { background: #ffd7d9; color: #750e13; }
        .status-closed { background: #d0e2ff; color: #002d9c; }
        .status-inprogress { background: #fcf4d6; color: #684e00; }
        .status-migrated { background: #e0e0e0; color: #161616; }

        .status-badge { display: inline-block; padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; border-radius: 2px; }
        .status-badge.improved { background: #d2f4ea; color: #0e6027; }
        .status-badge.degraded { background: #ffd7d9; color: #750e13; }
        .status-badge.unchanged { background: #e0e0e0; color: #525252; }
        .status-badge.no-data { background: #f4f4f4; color: #8d8d8d; }

        .compare-btn { padding: 0.375rem 0.75rem; background: #0f62fe; color: #ffffff; border: none; cursor: pointer; font-size: 0.75rem; font-family: inherit; transition: all 0.2s ease; }
        .compare-btn:hover { background: #0353e9; transform: translateY(-1px); }

        .loading { text-align: center; padding: 3rem; color: #525252; background: #ffffff; border: 1px solid #e0e0e0; }
        .spinner { border: 3px solid #e0e0e0; border-top: 3px solid #0f62fe; border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; margin: 0 auto 1rem; }

        .comparison-header { background: #ffffff; padding: 1.5rem; margin-bottom: 1rem; border: 1px solid #e0e0e0; animation: slideDown 0.4s ease-out; }
        .comparison-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .info-item { padding: 0.75rem; background: #f4f4f4; border-left: 3px solid #0f62fe; transition: all 0.3s ease; }
        .info-item:hover { background: #e0e0e0; transform: translateX(4px); }
        .info-label { font-size: 0.75rem; color: #525252; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-value { font-size: 1rem; font-weight: 600; margin-top: 0.25rem; }

        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .summary-card { background: #ffffff; padding: 1rem; border: 1px solid #e0e0e0; text-align: center; transition: all 0.3s ease; }
        .summary-card:hover { transform: translateY(-4px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .summary-label { font-size: 0.75rem; color: #525252; text-transform: uppercase; }
        .summary-value { font-size: 2rem; font-weight: 600; margin-top: 0.5rem; }
        .summary-card.improved { border-left: 4px solid #24a148; }
        .summary-card.degraded { border-left: 4px solid #da1e28; }
        .summary-card.unchanged { border-left: 4px solid #0f62fe; }

        .change-improved { color: #24a148; }
        .change-degraded { color: #da1e28; }
        .change-unchanged { color: #525252; }
        .change-no-data { color: #8d8d8d; }
        .mono { font-family: 'IBM Plex Mono', 'Courier New', monospace; }

        .critical-badge { display: inline-block; padding: 0.125rem 0.375rem; background: #da1e28; color: #ffffff; font-size: 0.625rem; font-weight: 700; text-transform: uppercase; margin-left: 0.5rem; border-radius: 2px; letter-spacing: 0.5px; }
        .highly-critical-row { background: #fff1f1 !important; border-left: 4px solid #da1e28 !important; }
        .highly-critical-row:hover { background: #ffe0e0 !important; }
        .critical-alert { background: #fff1f1; border-left: 4px solid #da1e28; padding: 1rem; margin-bottom: 1rem; animation: slideDown 0.4s ease-out; }
        .critical-alert-title { font-size: 0.875rem; font-weight: 600; color: #750e13; margin-bottom: 0.5rem; }
        .critical-alert-text { font-size: 0.75rem; color: #750e13; }

        .clickable-cell { cursor: pointer; text-decoration: underline; transition: all 0.2s ease; }
        .clickable-cell:hover { color: #0f62fe; font-weight: 600; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s ease-in; }
        .modal-content { background-color: #ffffff; margin: 5% auto; padding: 0; border: 1px solid #8d8d8d; width: 90%; max-width: 1200px; max-height: 80vh; overflow: auto; animation: slideDown 0.4s ease-out; }
        .modal-header { background: #e0e0e0; padding: 1rem 1.5rem; border-bottom: 1px solid #8d8d8d; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.125rem; font-weight: 600; }
        .modal-close { font-size: 1.5rem; font-weight: 700; color: #8d8d8d; cursor: pointer; background: none; border: none; padding: 0; line-height: 1; }
        .modal-close:hover { color: #161616; }
        .modal-body { padding: 1.5rem; }

        .pagination-container { background: #ffffff; padding: 1rem 1.5rem; margin-top: 1rem; border: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; animation: slideUp 0.5s ease-out; }
        .pagination-info { font-size: 0.875rem; color: #525252; }
        .pagination-controls { display: flex; gap: 0.5rem; align-items: center; }
        .page-btn { padding: 0.5rem 0.75rem; background: #ffffff; border: 1px solid #8d8d8d; color: #161616; cursor: pointer; font-size: 0.875rem; font-family: inherit; transition: all 0.2s ease; min-width: 40px; }
        .page-btn:hover:not(:disabled) { background: #e0e0e0; border-color: #0f62fe; }
        .page-btn.active { background: #0f62fe; color: #ffffff; border-color: #0f62fe; }
        .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .page-ellipsis { padding: 0.5rem; color: #525252; }

        .portfolio-header { background: #ffffff; padding: 1.5rem; margin-bottom: 1rem; border: 1px solid #e0e0e0; }
        .portfolio-header h2 { font-size: 1.25rem; font-weight: 400; margin-bottom: 0.5rem; }
        .portfolio-header p { color: #525252; font-size: 0.875rem; }

        /* 17 Metrics Grid */
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.25rem; margin-bottom: 2rem; }
        .metric-card { background: #ffffff; padding: 1.5rem; border: 1px solid #e0e0e0; border-top: 4px solid #0f62fe; border-radius: 8px; transition: all 0.3s cubic-bezier(0.2, 0, 0.38, 0.9); position: relative; overflow: hidden; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.04); }
        .metric-card:hover { transform: translateY(-6px); box-shadow: 0 12px 24px rgba(0,0,0,0.08); border-color: #0f62fe; }
        .metric-card.critical { border-top-color: #da1e28; }
        .metric-card.warning { border-top-color: #ff832b; }
        .metric-card.success { border-top-color: #24a148; }
        .metric-label { font-size: 0.8125rem; color: #525252; text-transform: uppercase; font-weight: 600; letter-spacing: 0.75px; height: 40px; display: flex; align-items: flex-start; }
        .metric-value { font-size: 2.25rem; font-weight: 700; color: #161616; margin: 0.75rem 0; font-variant-numeric: tabular-nums; }
        .metric-subtitle { font-size: 0.8125rem; color: #697077; background: #f4f4f4; display: inline-block; padding: 2px 8px; border-radius: 4px; }

        .portfolio-filters { background: #ffffff; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid #e0e0e0; border-radius: 8px; display: flex; gap: 1.5rem; align-items: flex-end; flex-wrap: wrap; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
        .portfolio-filter-group { display: flex; flex-direction: column; gap: 0.5rem; flex: 0 0 auto; }
        .portfolio-filter-label { font-size: 0.75rem; font-weight: 700; color: #697077; text-transform: uppercase; letter-spacing: 0.5px; }
        .filter-select, .multi-select-btn { height: 44px !important; width: 280px !important; box-sizing: border-box; flex: none !important; }

        /* Multi-Select Dropdown */
        .multi-select-container { position: relative; display: inline-block; }
        .multi-select-btn { height: 44px; padding: 0 1rem; border: 1px solid #dde1e6; background: #ffffff; font-size: 0.875rem; cursor: pointer; font-family: inherit; min-width: 300px; text-align: left; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s cubic-bezier(0.2, 0, 0.38, 0.9); border-radius: 4px; }
        .multi-select-btn:hover { border-color: #0f62fe; }
        .multi-select-btn .arrow { transition: transform 0.2s ease; font-size: 0.75rem; color: #525252; }
        .multi-select-btn.open { border-color: #0f62fe; box-shadow: 0 0 0 3px rgba(15, 98, 254, 0.1); }
        .multi-select-btn.open .arrow { transform: rotate(180deg); }
        .multi-select-dropdown { display: none; position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: #ffffff; border: 1px solid #dde1e6; border-radius: 8px; max-height: 400px; overflow-y: auto; z-index: 100; box-shadow: 0 12px 24px rgba(0,0,0,0.15); min-width: 320px; padding: 0.5rem 0; }
        .multi-select-dropdown.open { display: block; animation: slideDown 0.2s ease-out; }
        .multi-select-item { padding: 0.625rem 1rem; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; font-size: 0.875rem; transition: background 0.1s ease; }
        .multi-select-item:hover { background: #f2f4f8; }
        .multi-select-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: #0f62fe; cursor: pointer; border: 1px solid #8d8d8d; border-radius: 2px; }
        .multi-select-actions { padding: 1rem; border-top: 1px solid #e0e0e0; display: flex; gap: 1rem; justify-content: flex-end; background: #fbfbfc; border-radius: 0 0 8px 8px; }
        .multi-select-actions .btn { height: 36px; padding: 0 1rem; font-size: 0.8125rem; }
        .multi-select-count { background: #0f62fe; color: #fff; border-radius: 4px; padding: 2px 6px; font-size: 11px; font-weight: 700; margin-left: 8px; }

        /* Combined Results Card */
        .combined-results { background: #ffffff; padding: 1.5rem; margin-bottom: 1rem; border: 1px solid #e0e0e0; border-left: 4px solid #0f62fe; animation: slideDown 0.4s ease-out; }
        .combined-results h3 { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; }
        .combined-results .result-count { font-size: 2.5rem; font-weight: 700; color: #0f62fe; margin: 0.5rem 0; }
        .combined-results .result-params { font-size: 0.8125rem; color: #525252; margin-bottom: 1rem; }
        .combined-results .param-tag { display: inline-block; padding: 0.125rem 0.5rem; background: #e0e0e0; margin: 0.125rem; border-radius: 2px; font-size: 0.75rem; }

        /* Deviation Category Styles */
        .dev-categories { display: flex; flex-direction: column; gap: 0.75rem; margin-top: 0.5rem; }
        .dev-category { padding: 0.75rem; border-radius: 2px; }
        .dev-category-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.375rem; }
        .dev-category-critical { background: #fff1f1; border-left: 3px solid #da1e28; }
        .dev-category-critical .dev-category-title { color: #750e13; }
        .dev-category-consumer { background: #edf5ff; border-left: 3px solid #0f62fe; }
        .dev-category-consumer .dev-category-title { color: #002d9c; }
        .dev-category-commercial { background: #fff8e1; border-left: 3px solid #ff832b; }
        .dev-category-commercial .dev-category-title { color: #684e00; }
        .dev-category-bank { background: #defbe6; border-left: 3px solid #24a148; }
        .dev-category-bank .dev-category-title { color: #0e6027; }
        .dev-category-other { background: #f4f4f4; border-left: 3px solid #8d8d8d; }
        .dev-category-other .dev-category-title { color: #525252; }
        .dev-category ul { padding-left: 1.2rem; margin: 0; }
        .dev-category li { font-size: 0.8125rem; font-weight: 500; margin: 0.125rem 0; }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .search-bar, .filter-bar { flex-direction: column; }
            .filter-select { flex: 1; }
            table { font-size: 0.75rem; }
            th, td { padding: 0.5rem; }
            .pagination-container { flex-direction: column; gap: 1rem; }
            .pagination-controls { flex-wrap: wrap; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <img src="https://famescore.in/assets/images/fameImages/fameScoreLogo.png" alt="Fame Score Logo" class="header-logo">
            <h1>Fame Health Dashboard</h1>
        </div>
        <div class="cache-info">
            <span class="cache-badge">⚡ CACHED</span>
            <span>Instant load enabled</span>
        </div>
    </div>

    <div class="container">
        <div class="search-section" id="searchSection">
            <div class="search-bar">
                <input type="text" id="searchInput" class="search-input"
                       placeholder="Search by PAN, Old LOS ID, or New LOS ID">
                <button class="btn" onclick="searchData()">Search</button>
                <button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
            </div>
            <div class="filter-bar">
                <span class="filter-label">Status:</span>
                <select id="statusFilter" class="filter-select" onchange="applyFilters()">
                    <option value="">All Statuses</option>
                </select>
                <span class="filter-label" style="margin-left: 1rem;">Old Program:</span>
                <select id="oldProgramFilter" class="filter-select" onchange="applyFilters()">
                    <option value="">All Old Programs</option>
                </select>
                <span class="filter-label" style="margin-left: 1rem;">Child Program:</span>
                <select id="newProgramFilter" class="filter-select" onchange="applyFilters()">
                    <option value="">All Child Programs</option>
                </select>
            </div>
        </div>

        <div class="stats" id="statsBar">
            <div class="stat-item">Total Records: <span class="stat-value" id="totalRecords">0</span></div>
            <div class="stat-item">Showing: <span class="stat-value" id="showingRecords">0</span></div>
            <div class="stat-item" id="pageStatItem">Page: <span class="stat-value" id="currentPageDisplay">1</span></div>
        </div>

        <div class="view-toggle">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchView('dashboard')">Dashboard</button>
                <button class="tab-btn" onclick="switchView('portfolio')">Portfolio Analysis</button>
                <button class="tab-btn" id="compareTab" onclick="switchView('comparison')" style="display:none;">Comparison</button>
            </div>
        </div>

        <!-- DASHBOARD VIEW -->
        <div id="dashboardView" class="view active">
            <div id="loadingIndicator" class="loading">
                <div class="spinner"></div>
                <div>Loading data...</div>
            </div>
            <div id="tableContainer" style="display:none;">
                <table>
                    <thead>
                        <tr>
                            <th>PAN</th>
                            <th>Old LOS ID</th>
                            <th>Old Program</th>
                            <th>Old Status</th>
                            <th>New LOS ID</th>
                            <th>New Program</th>
                            <th>New Creation Date</th>
                            <th>New Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <div class="pagination-container">
                    <div class="pagination-info" id="paginationInfo"></div>
                    <div class="pagination-controls" id="paginationControls"></div>
                </div>
            </div>
        </div>

        <!-- PORTFOLIO VIEW -->
        <div id="portfolioView" class="view">
            <div id="portfolioLoading" class="loading" style="display:none;">
                <div class="spinner"></div>
                <div>Loading portfolio analysis...</div>
            </div>
            <div id="portfolioContent" style="display:none;">
                <div class="portfolio-header">
                    <h2>Portfolio Analysis — 17 Key Risk Indicators</h2>
                    <p>Click any metric card below to drill down into the specific cases.</p>
                </div>

                <div class="portfolio-filters">
                    <div class="portfolio-filter-group">
                        <span class="portfolio-filter-label">Old Status:</span>
                        <select id="portfolioOldStatusFilter" class="filter-select" onchange="loadPortfolioAnalysis()">
                            <option value="">All Statuses</option>
                        </select>
                    </div>
                    <div class="portfolio-filter-group">
                        <span class="portfolio-filter-label">Child Status:</span>
                        <select id="portfolioStatusFilter" class="filter-select" onchange="loadPortfolioAnalysis()">
                            <option value="">All Statuses</option>
                            <option value="Approved">Approved</option>
                            <option value="Rejected">Rejected</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Relook">Relook</option>
                            <option value="Credit Bucket">Credit Bucket</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <div class="portfolio-filter-group">
                        <span class="portfolio-filter-label">Child Program:</span>
                        <select id="portfolioProgramFilter" class="filter-select" onchange="loadPortfolioAnalysis()">
                            <option value="">All Programs</option>
                            <option value="Renewal program">Renewal Program</option>
                            <option value="Enhancement program">Enhancement Program</option>
                        </select>
                    </div>
                    <div class="portfolio-filter-group">
                        <span class="portfolio-filter-label">Parameters (AND):</span>
                        <div class="multi-select-container" id="multiSelectContainer">
                            <button class="multi-select-btn" id="multiSelectBtn" onclick="toggleMultiSelect()" type="button">
                                <span id="multiSelectLabel">Select Parameters...</span>
                                <span class="arrow">&#9660;</span>
                            </button>
                            <div class="multi-select-dropdown" id="multiSelectDropdown">
                                <div id="multiSelectItems"></div>
                                <div class="multi-select-actions">
                                    <button class="btn btn-secondary" onclick="clearMultiParamFilter()" type="button">Clear</button>
                                    <button class="btn" onclick="applyMultiParamFilter()" type="button">Apply AND</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="combinedResults" class="combined-results" style="display:none;">
                    <h3>&#x1F50D; AND Filter Results</h3>
                    <div class="result-count" id="combinedCount">0</div>
                    <div style="font-size: 0.875rem; color: #525252; margin-bottom: 0.5rem;">cases match <strong>ALL</strong> selected parameters</div>
                    <div class="result-params" id="combinedParams"></div>
                    <button class="btn" onclick="showCombinedCases()">View Cases</button>
                    <button class="btn btn-secondary" onclick="clearMultiParamFilter()" style="margin-left: 0.5rem;">Clear Filter</button>
                </div>

                <div id="allMetricsGrid" class="metrics-grid"></div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
                    <div>
                        <div class="portfolio-header"><h2>Industry Analysis</h2></div>
                        <table>
                            <thead><tr><th>Industry</th><th>CIBIL Drop</th><th>Willful Def</th><th>Sales Drop</th><th>DPD 30+</th></tr></thead>
                            <tbody id="industryBody"></tbody>
                        </table>
                    </div>
                    <div>
                        <div class="portfolio-header"><h2>State Analysis</h2></div>
                        <table>
                            <thead><tr><th>State</th><th>CIBIL Drop</th><th>Willful Def</th><th>Sales Drop</th><th>DPD 30+</th></tr></thead>
                            <tbody id="stateBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- COMPARISON VIEW -->
        <div id="comparisonView" class="view">
            <div id="comparisonLoading" class="loading" style="display:none;">
                <div class="spinner"></div>
                <div>Loading comparison...</div>
            </div>
            <div id="comparisonContent" style="display:none;">
                <div class="comparison-header">
                    <button class="btn btn-secondary" onclick="switchView('dashboard')">← Back to Dashboard</button>
                    <div class="comparison-info" id="comparisonInfo"></div>
                </div>
                <div class="summary-cards" id="summaryCards"></div>
                <table id="comparisonTable">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th id="oldDateHeader">Old Value</th>
                            <th id="newDateHeader">New Value</th>
                            <th>Change</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonTableBody"></tbody>
                </table>

                <!-- All Deviations Table -->
                <div id="deviationsTableSection" style="margin-top: 2rem; display: none;">
                    <div class="portfolio-header">
                        <h2>All Deviations</h2>
                        <p style="font-size: 0.8125rem; color: #525252;">Complete list of deviations with criticality level</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Deviation Name</th>
                                <th>Category</th>
                                <th>Criticality</th>
                            </tr>
                        </thead>
                        <tbody id="deviationsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Drill-Down Modal -->
    <div id="drillDownModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Cases</div>
                <button class="modal-close" onclick="closeDrillDown()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalLoading" class="loading" style="display:none;">
                    <div class="spinner"></div>
                    <div>Loading cases...</div>
                </div>
                <div id="modalContent" style="display:none;">
                    <div style="margin-bottom: 1rem; padding: 1rem; background: #f4f4f4; border-left: 3px solid #0f62fe;">
                        <div style="font-size: 0.875rem; color: #525252;">
                            Showing <strong id="drillDownCount">0</strong> cases
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>PAN</th>
                                <th>Old LOS ID</th>
                                <th>Old Status</th>
                                <th>New LOS ID</th>
                                <th>New Status</th>
                                <th>Industry</th>
                                <th>Info</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="modalTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const recordsPerPage = 20;
        let combinedFilterCases = [];

        window.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
            initMultiSelect();
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchData();
            });
        });

        // ---- DASHBOARD ----
        async function loadDashboardData(search = '') {
            const loading = document.getElementById('loadingIndicator');
            const container = document.getElementById('tableContainer');
            loading.style.display = 'block';
            container.style.display = 'none';

            try {
                const url = search ? `/api/dashboard?search=${encodeURIComponent(search)}` : '/api/dashboard';
                const response = await fetch(url);
                const result = await response.json();
                
                allData = result.data || [];
                populateFilters(allData);
                applyFilters();
                updateStats(result.total || 0);
                
                container.style.display = 'block';
                container.classList.add('fade-in');
            } catch (error) {
                console.error('Dashboard Load Error:', error);
                loading.innerHTML = `<div>Error loading data: ${error.message}</div>`;
            } finally {
                loading.style.display = 'none';
            }
        }

        function populateFilters(data) {
            // Status
            const statusFilter = document.getElementById('statusFilter');
            const statuses = new Set();
            data.forEach(row => statuses.add(row.new_status));
            statusFilter.innerHTML = '<option value="">All Statuses</option>';
            Array.from(statuses).sort().forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                statusFilter.appendChild(option);
            });

            // Old Program
            const oldProgFilter = document.getElementById('oldProgramFilter');
            const oldProgs = new Set();
            data.forEach(row => { if(row.old_program) oldProgs.add(row.old_program); });
            oldProgFilter.innerHTML = '<option value="">All Old Programs</option>';
            Array.from(oldProgs).sort().forEach(prog => {
                const option = document.createElement('option');
                option.value = prog;
                option.textContent = prog;
                oldProgFilter.appendChild(option);
            });

            // Child Program (New Program)
            const newProgFilter = document.getElementById('newProgramFilter');
            const newProgs = new Set();
            data.forEach(row => { if(row.new_program) newProgs.add(row.new_program); });
            newProgFilter.innerHTML = '<option value="">All Child Programs</option>';
            Array.from(newProgs).sort().forEach(prog => {
                const option = document.createElement('option');
                option.value = prog;
                option.textContent = prog;
                newProgFilter.appendChild(option);
            });
        }

        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const oldProgFilter = document.getElementById('oldProgramFilter').value;
            const newProgFilter = document.getElementById('newProgramFilter').value;

            filteredData = allData.filter(row => {
                if (statusFilter && row.new_status !== statusFilter) return false;
                if (oldProgFilter && row.old_program !== oldProgFilter) return false;
                if (newProgFilter && row.new_program !== newProgFilter) return false;
                return true;
            });
            currentPage = 1;
            renderPage();
        }

        function renderPage() {
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);
            renderTable(pageData);
            renderPagination();
            updateShowingCount();
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.style.animationDelay = `${index * 0.02}s`;
                tr.classList.add('fade-in');
                tr.innerHTML = `
                    <td class="mono">${row.pan}</td>
                    <td class="mono">${row.old_los_id}</td>
                    <td>${row.old_program}</td>
                    <td>${getStatusBadge(row.old_status)}</td>
                    <td class="mono">${row.new_los_id}</td>
                    <td>${row.new_program}</td>
                    <td>${row.new_created}</td>
                    <td>${getStatusBadge(row.new_status)}</td>
                    <td><button class="compare-btn" onclick="loadComparison(${row.old_los_id}, ${row.new_los_id})">Compare</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredData.length / recordsPerPage);
            const controls = document.getElementById('paginationControls');
            controls.innerHTML = '';

            controls.appendChild(createPageButton('First', 1, currentPage === 1));
            controls.appendChild(createPageButton('‹', currentPage - 1, currentPage === 1));


            getPageNumbers(currentPage, totalPages).forEach(page => {
                if (page === '...') {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'page-ellipsis';
                    ellipsis.textContent = '...';
                    controls.appendChild(ellipsis);
                } else {
                    controls.appendChild(createPageButton(page, page, false, page === currentPage));
                }
            });

            controls.appendChild(createPageButton('›', currentPage + 1, currentPage === totalPages));
            controls.appendChild(createPageButton('Last', totalPages, currentPage === totalPages));

            const startRecord = (currentPage - 1) * recordsPerPage + 1;
            const endRecord = Math.min(currentPage * recordsPerPage, filteredData.length);
            document.getElementById('paginationInfo').textContent =
                `Showing ${startRecord}-${endRecord} of ${filteredData.length} records`;
        }

        function createPageButton(text, page, disabled, active = false) {
            const btn = document.createElement('button');
            btn.className = 'page-btn' + (active ? ' active' : '');
            btn.textContent = text;
            btn.disabled = disabled;
            if (!disabled) btn.onclick = () => goToPage(page);
            return btn;
        }

        function getPageNumbers(current, total) {
            const pages = [];
            const delta = 2;
            for (let i = 1; i <= total; i++) {
                if (i === 1 || i === total || (i >= current - delta && i <= current + delta)) {
                    pages.push(i);
                } else if (pages[pages.length - 1] !== '...') {
                    pages.push('...');
                }
            }
            return pages;
        }

        function goToPage(page) {
            currentPage = page;
            renderPage();
            document.getElementById('currentPageDisplay').textContent = currentPage;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function getStatusBadge(status) {
            if (!status) return `<span class="status no-data">—</span>`;
            const s = String(status).toLowerCase();
            let className = 'status';
            if (s.includes('approved')) className += ' status-approved';
            else if (s.includes('rejected')) className += ' status-rejected';
            else if (s.includes('closed')) className += ' status-closed';
            else if (s.includes('progress')) className += ' status-inprogress';
            else if (s.includes('migrated')) className += ' status-migrated';
            return `<span class="${className}">${status}</span>`;
        }

        function updateStats(total) { document.getElementById('totalRecords').textContent = total.toLocaleString(); }
        function updateShowingCount() { document.getElementById('showingRecords').textContent = filteredData.length.toLocaleString(); }
        function searchData() { loadDashboardData(document.getElementById('searchInput').value); }
        function clearSearch() { 
            document.getElementById('searchInput').value = ''; 
            document.getElementById('statusFilter').value = ''; 
            document.getElementById('oldProgramFilter').value = ''; 
            document.getElementById('newProgramFilter').value = ''; 
            loadDashboardData(); 
        }

        // ---- COMPARISON ----
        async function loadComparison(oldId, newId) {
            const loading = document.getElementById('comparisonLoading');
            const content = document.getElementById('comparisonContent');
            const tab = document.getElementById('compareTab');

            switchView('comparison');
            tab.style.display = 'block';
            loading.style.display = 'block';
            content.style.display = 'none';

            try {
                const response = await fetch(`/api/compare?old=${oldId}&new=${newId}`);
                const data = await response.json();
                renderComparison(data);
                content.style.display = 'block';
                content.classList.add('fade-in');
            } catch (error) {
                loading.innerHTML = '<div>Error loading comparison</div>';
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderComparison(data) {
            document.getElementById('oldDateHeader').textContent = `Old LOS (${data.old_created})`;
            document.getElementById('newDateHeader').textContent = `New LOS (${data.new_created})`;

            const info = document.getElementById('comparisonInfo');
            info.innerHTML = `
                <div class="info-item"><div class="info-label">PAN</div><div class="info-value mono">${data.pan}</div></div>
                <div class="info-item"><div class="info-label">Old LOS ID</div><div class="info-value mono">${data.old_los_id}</div><div style="font-size:0.75rem;margin-top:0.25rem;">${data.old_program}</div></div>
                <div class="info-item"><div class="info-label">New LOS ID</div><div class="info-value mono">${data.new_los_id}</div><div style="font-size:0.75rem;margin-top:0.25rem;">${data.new_program}</div></div>
                <div class="info-item"><div class="info-label">Old Status</div><div class="info-value">${data.old_status}</div></div>
                <div class="info-item"><div class="info-label">New Status</div><div class="info-value">${data.new_status}</div></div>
                <div class="info-item"><div class="info-label">RM Name</div><div class="info-value">${data.rm_name || '—'}</div></div>
            `;

            if (data.categorized_deviations && Object.keys(data.categorized_deviations).length > 0) {
                const categoryStyles = {
                    'Critical': 'dev-category-critical',
                    'Consumer Bureau': 'dev-category-consumer',
                    'Commercial Bureau': 'dev-category-commercial',
                    'Bank Banking': 'dev-category-bank',
                    'Other': 'dev-category-other'
                };
                let devHtml = '<div class="dev-categories">';
                for (const [category, items] of Object.entries(data.categorized_deviations)) {
                    const styleClass = categoryStyles[category] || 'dev-category-other';
                    const itemsList = items.map(d => `<li>${d}</li>`).join('');
                    devHtml += `
                        <div class="dev-category ${styleClass}">
                            <div class="dev-category-title">${category} (${items.length})</div>
                            <ul>${itemsList}</ul>
                        </div>`;
                }
                devHtml += '</div>';
                info.innerHTML += `
                    <div class="info-item" style="grid-column: 1 / -1; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0; display: block;">
                        <div class="info-label">Critical Deviations (${data.critical_dev_count || 0})</div>
                        ${devHtml}
                    </div>
                `;
            } else if (data.deviations && data.deviations.length > 0) {
                 const devList = data.deviations.map(d => `<li>${d}</li>`).join('');
                 info.innerHTML += `
                    <div class="info-item" style="grid-column: 1 / -1; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0; display: block;">
                        <div class="info-label">Critical Deviations (0)</div>
                        <ul class="info-value" style="color: #da1e28; font-weight: 600; padding-left: 1.2rem; margin: 0.5rem 0;">
                            ${devList}
                        </ul>
                    </div>
                 `;
            }

            const stats = calculateStats(data.comparisons);
            const cards = document.getElementById('summaryCards');

            let criticalAlert = '';
            if (data.has_critical_case) {
                criticalAlert = `
                    <div class="critical-alert">
                        <div class="critical-alert-title">HIGHLY CRITICAL CASE DETECTED</div>
                        <div class="critical-alert-text">This case contains critical parameter changes (CIBIL drop ≥50 points or CMR increase ≥2 points)</div>
                    </div>
                `;
            }

            cards.innerHTML = criticalAlert + `
                <div class="summary-card improved"><div class="summary-label">Improved</div><div class="summary-value">${stats.improved}</div></div>
                <div class="summary-card degraded"><div class="summary-label">Degraded</div><div class="summary-value">${stats.degraded}</div></div>
                <div class="summary-card unchanged"><div class="summary-label">Unchanged</div><div class="summary-value">${stats.unchanged}</div></div>
                <div class="summary-card"><div class="summary-label">No Data</div><div class="summary-value">${stats.noData}</div></div>
            `;

            const tbody = document.getElementById('comparisonTableBody');
            tbody.innerHTML = '';

            data.comparisons.forEach((comp, index) => {
                const tr = document.createElement('tr');
                tr.style.animationDelay = `${index * 0.02}s`;
                tr.classList.add('fade-in');
                if (comp.is_highly_critical) tr.classList.add('highly-critical-row');

                let statusText = 'No Data', badgeClass = 'no-data';
                if (comp.status === 'improved') { statusText = 'Improved'; badgeClass = 'improved'; }
                else if (comp.status === 'degraded') { statusText = 'Degraded'; badgeClass = 'degraded'; }
                else if (comp.status === 'unchanged') { statusText = 'Unchanged'; badgeClass = 'unchanged'; }

                let parameterDisplay = comp.parameter;
                if (comp.is_critical) parameterDisplay += '<span class="critical-badge">CRITICAL</span>';

                tr.innerHTML = `
                    <td>${parameterDisplay}</td>
                    <td class="mono">${comp.old_value}</td>
                    <td class="mono">${comp.new_value}</td>
                    <td class="mono change-${comp.status}">${comp.change}</td>
                    <td><span class="status-badge ${badgeClass}">${statusText}</span></td>
                `;
                tbody.appendChild(tr);
            });

            // Render All Deviations Table
            const devSection = document.getElementById('deviationsTableSection');
            const devTbody = document.getElementById('deviationsTableBody');
            if (data.all_deviations_table && data.all_deviations_table.length > 0) {
                devTbody.innerHTML = '';
                data.all_deviations_table.forEach((dev, index) => {
                    const tr = document.createElement('tr');
                    tr.style.animationDelay = `${index * 0.02}s`;
                    tr.classList.add('fade-in');
                    let critClass = '';
                    if (dev.criticality === 'HIGH') { critClass = 'status-rejected'; }
                    else if (dev.criticality === 'MEDIUM') { critClass = 'status-inprogress'; }
                    else { critClass = 'status-migrated'; }
                    tr.innerHTML = `
                        <td><strong>${dev.name}</strong></td>
                        <td>${dev.category}</td>
                        <td><span class="status ${critClass}" style="font-weight:600;">${dev.criticality}</span></td>
                    `;
                    devTbody.appendChild(tr);
                });
                devSection.style.display = 'block';
            } else {
                devSection.style.display = 'none';
            }
        }

        function calculateStats(comparisons) {
            return comparisons.reduce((acc, comp) => {
                acc[comp.status === 'improved' ? 'improved' :
                    comp.status === 'degraded' ? 'degraded' :
                    comp.status === 'unchanged' ? 'unchanged' : 'noData']++;
                return acc;
            }, { improved: 0, degraded: 0, unchanged: 0, noData: 0 });
        }

        // ---- VIEW SWITCHING ----
        function switchView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            const searchSection = document.getElementById('searchSection');
            const statsBar = document.getElementById('statsBar');
            const pageStatItem = document.getElementById('pageStatItem');

            if (view === 'dashboard') {
                document.getElementById('dashboardView').classList.add('active');
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                if (searchSection) searchSection.style.display = 'block';
                if (statsBar) statsBar.style.display = 'flex';
                if (pageStatItem) pageStatItem.style.display = 'block';
            } else if (view === 'portfolio') {
                document.getElementById('portfolioView').classList.add('active');
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                if (searchSection) searchSection.style.display = 'none';
                if (statsBar) statsBar.style.display = 'none';
                if (pageStatItem) pageStatItem.style.display = 'none';
                // Trigger load (uses current filters)
                loadPortfolioAnalysis();
            } else {
                document.getElementById('comparisonView').classList.add('active');
                document.getElementById('compareTab').classList.add('active');
                if (searchSection) searchSection.style.display = 'none';
                if (statsBar) statsBar.style.display = 'none';
                if (pageStatItem) pageStatItem.style.display = 'none';
            }
        }

        // ---- PORTFOLIO (17 Metrics) ----
        async function loadPortfolioAnalysis() {
            const loading = document.getElementById('portfolioLoading');
            const content = document.getElementById('portfolioContent');
            loading.style.display = 'block';
            content.style.display = 'none';

            try {
                const oldStatus = document.getElementById('portfolioOldStatusFilter').value;
                const status = document.getElementById('portfolioStatusFilter').value;
                const program = document.getElementById('portfolioProgramFilter').value;
                const url = `/api/portfolio-analysis?old_status=${encodeURIComponent(oldStatus)}&status=${encodeURIComponent(status)}&program=${encodeURIComponent(program)}`;
                
                const response = await fetch(url);
                const data = await response.json();
                if (!oldStatus && !status && !program) {
                    populatePortfolioFilters(allData);
                }
                if (!data.total_pans && data.total_pans !== 0) { loading.innerHTML = '<div>No data available</div>'; return; }
                renderMetricsGrid(data);
                renderBreakdownTables(data);
                content.style.display = 'block';
                content.classList.add('fade-in');
                loading.style.display = 'none';
                // Auto-sync: re-apply AND filter if parameters are selected
                const selectedParams = getSelectedParams();
                if (selectedParams.length > 0) {
                    try { await applyMultiParamFilter(); } catch(e) { /* ignore sync errors */ }
                }
            } catch (error) {
                loading.innerHTML = '<div>Error loading portfolio analysis</div>';
                loading.style.display = 'block';
            }
        }

        function renderMetricsGrid(data) {
            const counts = data.counts || {};
            const total = data.total_pans;
            const val = (k) => counts[k] || 0;

            const metrics = [
                { id: 'cibil_drop_50plus', label: 'CIBIL Drop ≥50', type: 'critical' },
                { id: 'cibil_lt700_child', label: 'CIBIL <700 (Child)', type: 'critical' },
                { id: 'willful_default_child', label: 'Willful Default', type: 'critical' },
                { id: 'turnover_decreased', label: 'Turnover Decreased', type: 'critical' },
                { id: 'bto_drop_25pct', label: 'BTO Drop ≥25%', type: 'critical' },
                { id: 'purchase_gt_sales_30pct', label: 'Purchase > Sales 30%', type: 'critical' },
                { id: 'cmr_increase_2plus', label: 'CMR Increase ≥2', type: 'warning' },
                { id: 'cmr_rank_gt7_child', label: 'CMR Rank >7', type: 'warning' },
                { id: 'dpd_15plus_child', label: 'DPD 15+ (Child)', type: 'warning' },
                { id: 'dpd_30plus_child', label: 'DPD 30+ (Child)', type: 'warning' },
                { id: 'sales_dropped', label: 'Sales Dropped', type: 'warning' },
                { id: 'usl_increase_30pct', label: 'USL Increase ≥30%', type: 'warning' },
                { id: 'turnover_not_increased', label: 'Turnover Not Increased', type: 'warning' },
                { id: 'bto_gt_150pct', label: 'BTO > 150%', type: 'warning' },
                { id: 'deviation_count_1', label: '1 Deviation', type: 'success' },
                { id: 'deviation_count_2', label: '2 Deviations', type: 'warning' },
                { id: 'deviation_count_3plus', label: '3+ Deviations', type: 'critical' },
            ];

            document.getElementById('allMetricsGrid').innerHTML = metrics.map(m => {
                const count = val(m.id);
                const pct = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
                return `
                <div class="metric-card ${m.type}" onclick="showDrillDown('${m.id}', '${m.label}')">
                    <div class="metric-label">${m.label}</div>
                    <div class="metric-value">${count}</div>
                    <div class="metric-subtitle">${pct}% of ${total} cases</div>
                </div>`;
            }).join('');
        }

        function renderBreakdownTables(data) {
            const renderRows = (items, type) => items.slice(0, 15).map(i => {
                const filter = {};
                filter[type] = i.name;
                const filterStr = JSON.stringify(filter).replace(/"/g, "'");
                
                return `
                <tr>
                    <td><strong>${i.name}</strong></td>
                    <td class="mono clickable-cell" style="color:${i.cibil_drop_50plus>0?'#da1e28':''}" onclick="showDrillDown('cibil_drop_50plus', '${i.name} — CIBIL Drop', ${filterStr})">${i.cibil_drop_50plus||0}</td>
                    <td class="mono clickable-cell" style="color:${i.willful_default_child>0?'#da1e28':''}" onclick="showDrillDown('willful_default_child', '${i.name} — Willful Def', ${filterStr})">${i.willful_default_child||0}</td>
                    <td class="mono clickable-cell" onclick="showDrillDown('sales_dropped', '${i.name} — Sales Drop', ${filterStr})">${i.sales_dropped||0}</td>
                    <td class="mono clickable-cell" onclick="showDrillDown('dpd_30plus_child', '${i.name} — DPD 30+', ${filterStr})">${i.dpd_30plus_child||0}</td>
                </tr>
            `;}).join('');

            document.getElementById('industryBody').innerHTML = renderRows(data.industry_breakdown || [], 'industry');
            document.getElementById('stateBody').innerHTML = renderRows(data.state_breakdown || [], 'state');
        }

        // ---- DRILL-DOWN ----
        function populatePortfolioFilters(records) {
            const oldStatuses = new Set();
            const newStatuses = new Set();
            const programs = new Set();
            records.forEach(r => {
                if (r.old_status) oldStatuses.add(r.old_status);
                if (r.new_status) newStatuses.add(r.new_status);
                if (r.new_program) programs.add(r.new_program);
            });
            const oldStatusEl = document.getElementById('portfolioOldStatusFilter');
            const oldStatusVal = oldStatusEl.value;
            oldStatusEl.innerHTML = '<option value="">All Statuses</option>';
            [...oldStatuses].sort().forEach(s => {
                oldStatusEl.innerHTML += `<option value="${s}">${s}</option>`;
            });
            oldStatusEl.value = oldStatusVal;
            const newStatusEl = document.getElementById('portfolioStatusFilter');
            const newStatusVal = newStatusEl.value;
            newStatusEl.innerHTML = '<option value="">All Statuses</option>';
            [...newStatuses].sort().forEach(s => {
                newStatusEl.innerHTML += `<option value="${s}">${s}</option>`;
            });
            newStatusEl.value = newStatusVal;
            const programEl = document.getElementById('portfolioProgramFilter');
            const programVal = programEl.value;
            programEl.innerHTML = '<option value="">All Programs</option>';
            [...programs].sort().forEach(s => {
                programEl.innerHTML += `<option value="${s}">${s}</option>`;
            });
            programEl.value = programVal;
        }

        async function showDrillDown(metricId, label, extraFilters = {}) {
            const modal = document.getElementById('drillDownModal');
            const loading = document.getElementById('modalLoading');
            const content = document.getElementById('modalContent');
            const title = document.getElementById('modalTitle');

            title.textContent = label + ' — Cases';
            modal.style.display = 'block';
            loading.style.display = 'block';
            content.style.display = 'none';

            try {
                const oldStatus = document.getElementById('portfolioOldStatusFilter').value;
                const status = document.getElementById('portfolioStatusFilter').value;
                const program = document.getElementById('portfolioProgramFilter').value;
                
                let url = `/api/drill-down?metric=${metricId}&old_status=${encodeURIComponent(oldStatus)}&status=${encodeURIComponent(status)}&program=${encodeURIComponent(program)}`;
                
                if (extraFilters.industry) url += `&industry=${encodeURIComponent(extraFilters.industry)}`;
                if (extraFilters.state) url += `&state=${encodeURIComponent(extraFilters.state)}`;
                
                const response = await fetch(url);
                const data = await response.json();

                document.getElementById('drillDownCount').textContent = data.count;
                const tbody = document.getElementById('modalTableBody');
                tbody.innerHTML = '';

                data.cases.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    tr.style.animationDelay = `${index * 0.02}s`;
                    tr.classList.add('fade-in');
                    tr.innerHTML = `
                        <td class="mono">${row.pan}</td>
                        <td class="mono">${row.old_los}</td>
                        <td>${getStatusBadge(row.old_status)}</td>
                        <td class="mono">${row.new_los}</td>
                        <td>${getStatusBadge(row.new_status)}</td>
                        <td>${row.industry || '—'}</td>
                        <td style="color: #da1e28; font-weight: 600;">${row.info || '—'}</td>
                        <td><button class="compare-btn" onclick="closeDrillDown(); loadComparison(${row.old_los}, ${row.new_los})">Compare</button></td>
                    `;
                    tbody.appendChild(tr);
                });

                content.style.display = 'block';
                loading.style.display = 'none';
            } catch (error) {
                alert('Error loading drill-down data');
                closeDrillDown();
            }
        }

        function closeDrillDown() {
            document.getElementById('drillDownModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('drillDownModal');
            if (event.target === modal) closeDrillDown();
            // Close multi-select dropdown when clicking outside
            const msContainer = document.getElementById('multiSelectContainer');
            if (msContainer && !msContainer.contains(event.target)) {
                document.getElementById('multiSelectDropdown').classList.remove('open');
                document.getElementById('multiSelectBtn').classList.remove('open');
            }
        }

        // ---- MULTI-SELECT PARAMETER FILTER ----
        function initMultiSelect() {
            const container = document.getElementById('multiSelectItems');
            if (!container) return;
            const metrics = [
                { id: 'cibil_drop_50plus', label: 'CIBIL Drop \u226550' },
                { id: 'cibil_lt700_child', label: 'CIBIL <700 (Child)' },
                { id: 'willful_default_child', label: 'Willful Default' },
                { id: 'turnover_decreased', label: 'Turnover Decreased' },
                { id: 'bto_drop_25pct', label: 'BTO Drop \u226525%' },
                { id: 'purchase_gt_sales_30pct', label: 'Purchase > Sales 30%' },
                { id: 'cmr_increase_2plus', label: 'CMR Increase \u22652' },
                { id: 'cmr_rank_gt7_child', label: 'CMR Rank >7' },
                { id: 'dpd_15plus_child', label: 'DPD 15+ (Child)' },
                { id: 'dpd_30plus_child', label: 'DPD 30+ (Child)' },
                { id: 'sales_dropped', label: 'Sales Dropped' },
                { id: 'usl_increase_30pct', label: 'USL Increase \u226530%' },
                { id: 'turnover_not_increased', label: 'Turnover Not Increased' },
                { id: 'bto_gt_150pct', label: 'BTO > 150%' },
                { id: 'deviation_count_1', label: '1 Deviation' },
                { id: 'deviation_count_2', label: '2 Deviations' },
                { id: 'deviation_count_3plus', label: '3+ Deviations' },
            ];
            container.innerHTML = metrics.map(m => `
                <label class="multi-select-item">
                    <input type="checkbox" value="${m.id}" onchange="updateMultiSelectLabel()">
                    ${m.label}
                </label>
            `).join('');
        }

        function toggleMultiSelect() {
            const dropdown = document.getElementById('multiSelectDropdown');
            const btn = document.getElementById('multiSelectBtn');
            dropdown.classList.toggle('open');
            btn.classList.toggle('open');
        }

        function updateMultiSelectLabel() {
            const checkboxes = document.querySelectorAll('#multiSelectItems input[type="checkbox"]:checked');
            const label = document.getElementById('multiSelectLabel');
            if (checkboxes.length === 0) {
                label.innerHTML = 'Select Parameters...';
            } else {
                label.innerHTML = `${checkboxes.length} selected<span class="multi-select-count">${checkboxes.length}</span>`;
            }
        }

        function getSelectedParams() {
            const checkboxes = document.querySelectorAll('#multiSelectItems input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        async function applyMultiParamFilter() {
            const selected = getSelectedParams();
            if (selected.length === 0) {
                clearMultiParamFilter();
                return;
            }

            // Close dropdown
            document.getElementById('multiSelectDropdown').classList.remove('open');
            document.getElementById('multiSelectBtn').classList.remove('open');

            const oldStatus = document.getElementById('portfolioOldStatusFilter').value;
            const status = document.getElementById('portfolioStatusFilter').value;
            const program = document.getElementById('portfolioProgramFilter').value;
            const url = `/api/multi-param-filter?params=${encodeURIComponent(selected.join(','))}&old_status=${encodeURIComponent(oldStatus)}&status=${encodeURIComponent(status)}&program=${encodeURIComponent(program)}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                combinedFilterCases = data.cases || [];

                // Show combined results card
                const resultsDiv = document.getElementById('combinedResults');
                document.getElementById('combinedCount').textContent = data.count;

                // Show selected param tags
                const paramLabels = {
                    'cibil_drop_50plus': 'CIBIL Drop \u226550', 'cibil_lt700_child': 'CIBIL <700',
                    'willful_default_child': 'Willful Default', 'turnover_decreased': 'Turnover Decreased',
                    'bto_drop_25pct': 'BTO Drop \u226525%', 'purchase_gt_sales_30pct': 'Purchase > Sales 30%',
                    'cmr_increase_2plus': 'CMR Increase \u22652', 'cmr_rank_gt7_child': 'CMR Rank >7',
                    'dpd_15plus_child': 'DPD 15+', 'dpd_30plus_child': 'DPD 30+',
                    'sales_dropped': 'Sales Dropped', 'usl_increase_30pct': 'USL Increase \u226530%',
                    'turnover_not_increased': 'Turnover Not Increased', 'bto_gt_150pct': 'BTO > 150%',
                    'deviation_count_1': '1 Deviation', 'deviation_count_2': '2 Deviations',
                    'deviation_count_3plus': '3+ Deviations'
                };
                const tags = selected.map(p => `<span class="param-tag">${paramLabels[p] || p}</span>`).join(' ');
                document.getElementById('combinedParams').innerHTML = '<strong>Selected:</strong> ' + tags;

                resultsDiv.style.display = 'block';
                resultsDiv.classList.add('fade-in');

                // UPDATE PORTFOLIO VIEW (Cards & Tables) with filtered data
                // If count is 0, we should clear the grid or show 0s. The render functions handle 0s gracefully.
                renderMetricsGrid(data);
                renderBreakdownTables(data);

            } catch (error) {
                alert('Error fetching AND filter results: ' + error.message);
            }
        }

        function clearMultiParamFilter() {
            // Uncheck all
            document.querySelectorAll('#multiSelectItems input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateMultiSelectLabel();

            // Close dropdown
            document.getElementById('multiSelectDropdown').classList.remove('open');
            document.getElementById('multiSelectBtn').classList.remove('open');

            // Hide combined results
            document.getElementById('combinedResults').style.display = 'none';
            combinedFilterCases = [];

            // Reload full portfolio (respecting status/program filters)
            loadPortfolioAnalysis();
        }

        function showCombinedCases() {
            const modal = document.getElementById('drillDownModal');
            const content = document.getElementById('modalContent');
            const loading = document.getElementById('modalLoading');
            const title = document.getElementById('modalTitle');

            title.textContent = 'AND Filter \u2014 Combined Cases';
            modal.style.display = 'block';
            loading.style.display = 'none';

            document.getElementById('drillDownCount').textContent = combinedFilterCases.length;
            const tbody = document.getElementById('modalTableBody');
            tbody.innerHTML = '';

            combinedFilterCases.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.style.animationDelay = `${index * 0.02}s`;
                tr.classList.add('fade-in');
                tr.innerHTML = `
                    <td class="mono">${row.pan}</td>
                    <td class="mono">${row.old_los}</td>
                    <td>${getStatusBadge(row.old_status)}</td>
                    <td class="mono">${row.new_los}</td>
                    <td>${getStatusBadge(row.new_status)}</td>
                    <td>${row.industry || '\u2014'}</td>
                    <td style="color: #da1e28; font-weight: 600;">${row.info || '\u2014'}</td>
                    <td><button class="compare-btn" onclick="closeDrillDown(); loadComparison(${row.old_los}, ${row.new_los})">Compare</button></td>
                `;
                tbody.appendChild(tr);
            });

            content.style.display = 'block';
        }
    </script>
</body>
</html>
"""

@app.route('/')
def index():
    return HTML_TEMPLATE

# Load pre-computed data (loads once at startup)
load_precomputed_data()

if __name__ == '__main__':
    print("\n" + "=" * 80)
    print("STARTING FAST SERVER")
    print("=" * 80)
    print("\nOpen http://localhost:5005 in your browser")
    app.run(debug=True, host='0.0.0.0', port=5005)
